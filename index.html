<!DOCTYPE html>
<html lang="en" manifest="geo2share.manifest">
<head>
    <meta charset=utf-8>
    <meta name="viewport" content="width=620">
    <title>geoshare</title>
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="shortcut icon" sizes="192x192" href="./Centre_mark.svg.png">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <style>
    button,
    textarea {
        width: 99%;
    }
    button {
        font-size: 4em;
        padding: 0.4em;
        margin-bottom: 15px;
    }
    #msg { border: 1px solid #8da7cc; border-left-width: 20px;color: green;font-size: 130%;padding: 5px;} 
    </style>
</head>
<body onload="getLocation()" >

    <textarea id="adress" style="height: 6em;" ></textarea>
    <br />
    <button onclick="getStreetZipCity(adress)" >get adress</button>

    <textarea id="geo" >getting location</textarea>
    <br />
    <button onclick="copyGeo(geo)" >Copy geoURI</button>

    <textarea id="osm" >getting location</textarea>
    <br />
    <button onclick="copyGeo(osm)" >Copy OSM link</button>
    <a id="osmlink" href="">link to osm</a>

    <div id="msg"></div>

<script>
var geo = document.getElementById("geo");
var osm = document.getElementById("osm");
var adress = document.getElementById("adress");

var osmlink = document.getElementById("osmlink");
var osmreverse = document.getElementById("osmreverse");
var copybtn = document.getElementById("copybtn");
var msg = document.getElementById("msg");


function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(createLinks);
    } else {
        msg.innerHTML = "Geolocation is not supported by this browser.";
    }
    return ;
}
function createLinks(position) {
    geouri = "geo:" + position.coords.latitude + "," + position.coords.longitude;
    osmurl = "http://www.openstreetmap.org/?mlat="+ position.coords.latitude + "&mlon=" + position.coords.longitude ;
    reverseurl = '//nominatim.openstreetmap.org/reverse?format=json&lat=' + position.coords.latitude + '&lon=' + position.coords.longitude ;

    geo.innerHTML = geouri ;
    osm.innerHTML = osmlink.innerHTML = osmurl ;
    osmlink.setAttribute('href', osmurl );

}

function copyGeo( copytext ) {
      getLocation(); // if device has moved
      copytext.select();
      document.execCommand('copy');
      msg.innerHTML =  "<em>" + copytext.innerHTML + "</em> copied" ;
      copytext.blur() ;
}

var getJSON = function(url) {
  return new Promise(function(resolve, reject) {
    var xhr = new XMLHttpRequest();
    xhr.open('get', url, true);
    xhr.responseType = 'json';
    xhr.onload = function() {
      var status = xhr.status;
      if (status == 200) {
        resolve(xhr.response);
      } else {
        reject(status);
      }
    };
    xhr.send();
  });
};


function getStreetZipCity(adressfield) {
    msg.innerHTML = "getting adress" ;
    adress.innerHTML = "" ; // blank to avoid old location
    getLocation(); // if device has moved
    getJSON( reverseurl ).then(function(data) {
        var adresslist = data.address ;
        adress.innerHTML =  
        //~ adresslist.building +
        adresslist.road + '\n' +
        //~ adresslist.suburb +
        //~ adresslist.city_district +
        adresslist.postcode +  ' ' +
        adresslist.city + '\n' +
        //~ adresslist.state_district +
        //~ adresslist.state +
        adresslist.country ;

        copyGeo( adressfield );

    }, function(status) { 
        msg.innerHTML = status ; // TODO
    });

}

</script>
</body>
</html>
